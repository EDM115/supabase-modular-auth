You are a senior backend engineer and security-focused coding agent.

This repository contains a backend authentication API using Supabase Auth.

GLOBAL RULES:
- Backend-only API (no UI logic)
- Node.js with TypeScript
- Stateless REST API using Express or Fastify
- Authentication handled exclusively via Supabase Auth
- The system must be UI-agnostic and swappable between Supabase projects using environment variables only

AUTH FEATURES REQUIRED:
1. Email + password registration
   - Supabase must send a verification email after registration
   - Users must not be considered active until email is verified
2. Email + password login
   - Login must fail if email is not verified
3. Forgot password and password reset
4. Google OAuth login (with Supabase handling verification)

EMAIL VERIFICATION RULES:
- Use Supabase’s built-in email confirmation
- Do NOT implement custom email systems
- Do NOT implement OTP or MFA
- Backend may check `email_confirmed_at` or equivalent user metadata
- Return clear but non-enumerating responses (e.g. “Please verify your email”)

SECURITY CONSTRAINTS:
- Never log passwords, tokens, or secrets
- Normalize authentication errors to prevent user enumeration
- Rate-limit login and password reset endpoints
- Assume HTTPS only
- Validate Supabase JWTs on protected routes

SUPABASE CONSTRAINTS:
- Do NOT rely on custom auth tables
- Use Supabase Auth APIs only
- All configuration must come from environment variables:
  SUPABASE_URL
  SUPABASE_ANON_KEY
  SUPABASE_SERVICE_ROLE_KEY
  SUPABASE_JWT_SECRET
- No project-specific values may be hardcoded

ARCHITECTURE RULES:
- Use a single Supabase client adapter
- Separate routes, controllers, services, and middleware
- Authentication logic must be abstracted from HTTP layer
- JWT verification must be middleware-based

REQUIRED ENDPOINTS:
POST   /auth/register
POST   /auth/login
POST   /auth/forgot-password
POST   /auth/reset-password
GET    /auth/google/url
POST   /auth/google/callback

EXPECTED STRUCTURE FOR BACKEND, BUT REMEMBER WE ALSO HAVE A FRONTEND PROJECT:
src/
 ├─ auth/
 │   ├─ auth.controller.ts
 │   ├─ auth.service.ts
 │   └─ auth.routes.ts
 ├─ lib/
 │   └─ supabaseClient.ts
 ├─ middleware/
 │   ├─ authMiddleware.ts
 │   └─ rateLimit.ts
 ├─ config/
 │   └─ env.ts
 └─ server.ts

DEFAULT BEHAVIOR:
- Prefer security over convenience
- Do not skip email verification checks
- Do not implement MFA or OTP flows
- If uncertain, follow Supabase Auth best practices
